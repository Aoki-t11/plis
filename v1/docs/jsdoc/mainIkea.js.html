<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>mainIkea.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://hiroshi-sugimura.github.io/plis/" target="_blank" class="menu-item" id="forum_link" >Website</a></h2><h2><a href="https://github.com/Hiroshi-Sugimura/plis" target="_blank" class="menu-item" id="website_link" >Github</a></h2><h3>Modules</h3><ul><li><a href="module-main.html">main</a><ul class='methods'><li data-type='method'><a href="module-main.html#~createWindow">createWindow</a></li></ul></li><li><a href="module-mainArp.html">mainArp</a></li><li><a href="module-mainCalendar.html">mainCalendar</a></li><li><a href="module-mainEL.html">mainEL</a></li><li><a href="module-mainESM.html">mainESM</a></li><li><a href="module-mainHALlocal.html">mainHALlocal</a></li><li><a href="module-mainHALsync.html">mainHALsync</a></li><li><a href="module-mainHue.html">mainHue</a></li><li><a href="module-mainIkea.html">mainIkea</a></li><li><a href="module-mainJma.html">mainJma</a></li><li><a href="module-mainNetatmo.html">mainNetatmo</a></li><li><a href="module-mainOmron.html">mainOmron</a></li><li><a href="module-mainOwm.html">mainOwm</a></li><li><a href="module-mainSubmodule.html">mainSubmodule</a></li><li><a href="module-mainSwitchBot.html">mainSwitchBot</a><ul class='methods'><li data-type='method'><a href="module-mainSwitchBot.html#~control">control</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getCases">getCases</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getConfig">getConfig</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getHumidityRows">getHumidityRows</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getMeterList">getMeterList</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getPersist">getPersist</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getTempratureRows">getTempratureRows</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~getTodayRoomEnvSwitchBot">getTodayRoomEnvSwitchBot</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~renewFacilities">renewFacilities</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~sendTodayRoomEnv">sendTodayRoomEnv</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~setConfig">setConfig</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~start">start</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~stop">stop</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~stopObservation">stopObservation</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~stopWithoutSave">stopWithoutSave</a></li><li data-type='method'><a href="module-mainSwitchBot.html#~storeData">storeData</a></li></ul></li><li><a href="module-mainSystem.html">mainSystem</a><ul class='methods'><li data-type='method'><a href="module-mainSystem.html#~getConfig">getConfig</a></li><li data-type='method'><a href="module-mainSystem.html#~setConfig">setConfig</a></li><li data-type='method'><a href="module-mainSystem.html#~stop">stop</a></li></ul></li><li><a href="module-mainUser.html">mainUser</a><ul class='methods'><li data-type='method'><a href="module-mainUser.html#~getConfig">getConfig</a></li><li data-type='method'><a href="module-mainUser.html#~setConfig">setConfig</a></li><li data-type='method'><a href="module-mainUser.html#~start">start</a></li><li data-type='method'><a href="module-mainUser.html#~stop">stop</a></li></ul></li><li><a href="module-subEL.html">subEL</a></li><li></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">mainIkea.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//////////////////////////////////////////////////////////////////////
//	Copyright (C) Hiroshi SUGIMURA 2020.10.30
//////////////////////////////////////////////////////////////////////
/**
 * @module mainIkea
 */
'use strict'

//////////////////////////////////////////////////////////////////////
// 基本ライブラリ
const Store = require('electron-store');
const TF = require('tradfri-handler');
const cron = require('node-cron');
const { Sequelize, sqlite3 } = require('./models/localDBModels');   // DBデータと連携
const { objectSort, getNow, getToday, isObjEmpty, mergeDeeply} = require('./mainSubmodule');

let sendIPCMessage = null;

const store = new Store();

let config = {
	enabled: false,
	securityCode: "",
	identity: "",
	psk: "",
	debug: false
};

let persist = {};


//////////////////////////////////////////////////////////////////////
// config
let mainIkea = {
	callback: null,
	observationJob: null,
	isRun: false,

	//////////////////////////////////////////////////////////////////////
	// interfaces
	start: async function ( _sendIPCMessage ) {
		sendIPCMessage = _sendIPCMessage;

		if( mainIkea.isRun ) { // 重複起動対策
			if( !isObjEmpty(persist) ) {
				sendIPCMessage( "renewIkeaConfigView", config );
				sendIPCMessage( "fclIkea", persist );
			}
			return;
		}

		config.enabled      = store.get('config.Ikea.enabled', false);
		config.securityCode = store.get('config.Ikea.securityCode', '');
		config.identity     = store.get('config.Ikea.identity', '');
		config.psk          = store.get('config.Ikea.psk', '');
		config.debug        = store.get('config.Ikea.debug', false);
		persist = store.get('persist.Ikea', {});
		sendIPCMessage( "renewIkeaConfigView", config );



		if( config.enabled == false ) {
			config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.start() disabled.'):0;
			mainIkea.isRun = false;
			return;
		}
		mainIkea.isRun = true;

		config.debug? console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.start(), config:\x1b[32m', config, '\x1b[0m'):0;

		try{
			let co = await mainIkea.startCore( ( facilities ) => {
				persist = facilities;
				if( !isObjEmpty(persist) ) {
					sendIPCMessage( "fclIKEA", persist  );
				}
			} );

			config.identity = co.identity;
			config.psk = co.psk;
			config.debug? console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mianIkea.start() is connected. config:\x1b[32m', config, '\x1b[0m'):0;
			await store.set('config.Ikea', config);

		}catch( error ) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.start() error:\x1b[32m', error, '\x1b[0m');
			config.enabled = false;
			mainIkea.isRun = false;
			return;
		}

		if( !isObjEmpty(persist) ) {
			sendIPCMessage( "fclIkea", persist );
		}
	},

	stop: async function () {
		mainIkea.isRun = false;

		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.stop()'):0;

		await mainIkea.stop();

		await mainIkea.setConfig();
		await store.set('persist.Ikea', persist);
	},

	stopWithoutSave: async function () {
		mainIkea.isRun = false;

		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.stopWithoutSave()'):0;

		await mainIkea.stop();
	},



	setConfig: async function ( _config ) {
		if( _config ) {
			config = mergeDeeply( config, _config );
		}
		await store.set('config.Ikea', config);

		sendIPCMessage( "renewIkeaConfigView", config );  // 保存したので画面に通知
		sendIPCMessage( "configSaved", 'Ikea' );  // 保存したので画面に通知
	},

	getConfig: function () {
		return config;
	},

	getPersist: function() {
		return persist;
	},


	//////////////////////////////////////////////////////////////////////
	// inner functions
	startCore: async function( callback ) {
		if( !config.securityCode || config.securityCode == "" ) {
			console.error('mainIkea.startCore() config.key is not valid.');
		}

		mainIkea.callback     = callback;

		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.startCore() config::\x1b[32m', config, '\x1b[0m' ):0;

		let ret;
		try{
			ret = await TF.initialize( config.securityCode, mainIkea.received, {identity: config.identity, psk: config.psk, debugMode:config.debug} );
			mainIkea.observe();
			return ret;
		}catch(error){
			console.error( 'mainIkea.startCore() error:\x1b[32m', error, '\x1b[0m');
			throw error;
		}
	},


	// 受信データ処理
	received: function(rIP, device, error) {
		if( error ) {
			console.log('-- received error');
			console.error( error );
			return;
		}

		// if( device.type === AccessoryTypes.lightbulb ) {
		// console.log( device );
		// }
		// console.log('-- received, IP:', rIP, ', device:', device);
	},


	// Ikeaを監視する
	observe: async function( interval ) {
		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.observe() start.' ):0;

		if( mainIkea.observationJob ) {
			config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.observe() already started.' ):0;
		}

		// facilitiesの定期的監視
		let oldVal = JSON.stringify( TF.objectSort(TF.facilities) );
		mainIkea.observationJob = cron.schedule('0 * * * * *', () => {  // 1分毎にautoget、変化があればログ表示
			const newVal = JSON.stringify( TF.objectSort(TF.facilities) );
			if ( oldVal == newVal ) return; // 変化した
			oldVal = newVal;
			mainIkea.callback( TF.facilities );
			// console.log('TF changed, new TF.facilities:', newVal);
		});
		mainIkea.observationJob.start();
	},


	// 監視をやめる、リリースする
	stop: function() {
		config.debug? console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainIkea.stop().' ):0;

		if( mainIkea.observationJob ) {
			mainIkea.observationJob.stop();
			mainIkea.observationJob = null;
		}
		TF.release();
	}
};



module.exports = mainIkea;
//////////////////////////////////////////////////////////////////////
// EOF
//////////////////////////////////////////////////////////////////////
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Sun May 28 2023 00:39:07 GMT+0900 (日本標準時) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
