<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>mainSwitchBot.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://hiroshi-sugimura.github.io/plis/" target="_blank" class="menu-item" id="forum_link" >Website</a></h2><h2><a href="https://github.com/Hiroshi-Sugimura/plis" target="_blank" class="menu-item" id="website_link" >Github</a></h2><h3>Classes</h3><ul><li><a href="module-mainArp-mainArp.html">mainArp</a></li></ul><h3>Modules</h3><ul><li><a href="module-main.html">main</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-main.html#~createShortCut">createShortCut</a></li><li data-type='method' style='display: none;'><a href="module-main.html#~createWindow">createWindow</a></li><li data-type='method' style='display: none;'><a href="module-main.html#~menuInitialize">menuInitialize</a></li><li data-type='method' style='display: none;'><a href="module-main.html#~saveConfig">saveConfig</a></li><li data-type='method' style='display: none;'><a href="module-main.html#~savePersist">savePersist</a></li></ul></li><li><a href="module-mainArp.html">mainArp</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainArp.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~stopWithoutSave">stopWithoutSave</a></li><li data-type='method' style='display: none;'><a href="module-mainArp.html#~toMAC">toMAC</a></li></ul></li><li><a href="module-mainCalendar.html">mainCalendar</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainCalendar.html#~getHolidays">getHolidays</a></li><li data-type='method' style='display: none;'><a href="module-mainCalendar.html#~start">start</a></li></ul></li><li><a href="module-mainEL.html">mainEL</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainEL.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~getStatic">getStatic</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~getTodayElectricEnergy_submeter">getTodayElectricEnergy_submeter</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~init">init</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~observation">observation</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~received">received</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~search">search</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~sendMsg">sendMsg</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~sendOPC1">sendOPC1</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~sendTodayEnergy">sendTodayEnergy</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~setCron">setCron</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~sleep">sleep</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainEL.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainESM.html">mainESM</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainESM.html#~getCases">getCases</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~getRows">getRows</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~getTodayElectricEnergy">getTodayElectricEnergy</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~observe">observe</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~received">received</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~renewPortList">renewPortList</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~sendTodayEnergy">sendTodayEnergy</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~startCore">startCore</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainESM.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainHALlocal.html">mainHALlocal</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~calcMajorResults">calcMajorResults</a></li><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~getLastData">getLastData</a></li><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~getToday">getToday</a></li><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~roundMajorFloat">roundMajorFloat</a></li><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~submitQuestionnaire">submitQuestionnaire</a></li><li data-type='method' style='display: none;'><a href="module-mainHALlocal.html#~truncatelogs">truncatelogs</a></li></ul></li><li><a href="module-mainHALsync.html">mainHALsync</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~ConfigSave">ConfigSave</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~deleteHalApiToken">deleteHalApiToken</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~getHalUserProfileRequest">getHalUserProfileRequest</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~httpGetRequest">httpGetRequest</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~httpPostRequest">httpPostRequest</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~renewConfigView">renewConfigView</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~setHalApiTokenRequest">setHalApiTokenRequest</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~startSync">startSync</a></li><li data-type='method' style='display: none;'><a href="module-mainHALsync.html#~startUploadEldata">startUploadEldata</a></li></ul></li><li><a href="module-mainHue.html">mainHue</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainHue.html#~cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~control">control</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~dummy">dummy</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~received">received</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~startCore">startCore</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~startObserve">startObserve</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~stopObserve">stopObserve</a></li><li data-type='method' style='display: none;'><a href="module-mainHue.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainIkea.html">mainIkea</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~observe">observe</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~received">received</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~startCore">startCore</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainIkea.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainJma.html">mainJma</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainJma.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~gets">gets</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~parseAbst">parseAbst</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~parseAbstRaw">parseAbstRaw</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~parseDetail">parseDetail</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~parseDetailRaw">parseDetailRaw</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~setObserve">setObserve</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainJma.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainNetatmo.html">mainNetatmo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~getCases">getCases</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~getRows">getRows</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~getTodayRoomEnv">getTodayRoomEnv</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~sendTodayRoomEnv">sendTodayRoomEnv</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~setObserve">setObserve</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainNetatmo.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainOmron.html">mainOmron</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~getCases">getCases</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~getRows">getRows</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~getTodayRoomEnv">getTodayRoomEnv</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~sendTodayRoomEnv">sendTodayRoomEnv</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainOmron.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainOwm.html">mainOwm</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~setObserve">setObserve</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~startCore">startCore</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainOwm.html#~stopWithoutSave">stopWithoutSave</a></li></ul></li><li><a href="module-mainSubmodule.html">mainSubmodule</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainSubmodule.html#~getNow">getNow</a></li><li data-type='method' style='display: none;'><a href="module-mainSubmodule.html#~getToday">getToday</a></li><li data-type='method' style='display: none;'><a href="module-mainSubmodule.html#~isObjEmpty">isObjEmpty</a></li><li data-type='method' style='display: none;'><a href="module-mainSubmodule.html#~mergeDeeply">mergeDeeply</a></li><li data-type='method' style='display: none;'><a href="module-mainSubmodule.html#~objectSort">objectSort</a></li></ul></li><li><a href="module-mainSwitchBot.html">mainSwitchBot</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~control">control</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getCases">getCases</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getHumidityRows">getHumidityRows</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getMeterList">getMeterList</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getPersist">getPersist</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getTempratureRows">getTempratureRows</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~getTodayRoomEnvSwitchBot">getTodayRoomEnvSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~renewFacilities">renewFacilities</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~sendTodayRoomEnv">sendTodayRoomEnv</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~stop">stop</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~stopObservation">stopObservation</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~stopWithoutSave">stopWithoutSave</a></li><li data-type='method' style='display: none;'><a href="module-mainSwitchBot.html#~storeData">storeData</a></li></ul></li><li><a href="module-mainSystem.html">mainSystem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainSystem.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainSystem.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainSystem.html#~stop">stop</a></li></ul></li><li><a href="module-mainUser.html">mainUser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-mainUser.html#~getConfig">getConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainUser.html#~setConfig">setConfig</a></li><li data-type='method' style='display: none;'><a href="module-mainUser.html#~start">start</a></li><li data-type='method' style='display: none;'><a href="module-mainUser.html#~stop">stop</a></li></ul></li><li><a href="module-subCalendar.html">subCalendar</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~checkDate">checkDate</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~checkDate">checkDate</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~createProcess">createProcess</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~createProcess">createProcess</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~isHoliday">isHoliday</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~isHoliday">isHoliday</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~isToday">isToday</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~isToday">isToday</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~showProcess">showProcess</a></li><li data-type='method' style='display: none;'><a href="module-subCalendar.html#~showProcess">showProcess</a></li></ul></li><li></li><li><a href="module-subEL.html">subEL</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subEL.html#~convRT">convRT</a></li><li data-type='method' style='display: none;'><a href="module-subEL.html#~convRT">convRT</a></li><li data-type='method' style='display: none;'><a href="module-subEL.html#~renewCanvasSubESM">renewCanvasSubESM</a></li><li data-type='method' style='display: none;'><a href="module-subEL.html#~renewCanvasSubESM">renewCanvasSubESM</a></li><li data-type='method' style='display: none;'><a href="module-subEL.html#~renewIkeaConfigView">renewIkeaConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subEL.html#~renewIkeaConfigView">renewIkeaConfigView</a></li></ul></li><li></li><li><a href="module-subELcontrol.html">subELcontrol</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subELcontrol.html#~colorButton">colorButton</a></li><li data-type='method' style='display: none;'><a href="module-subELcontrol.html#~colorButton">colorButton</a></li></ul></li><li></li><li><a href="module-subESM.html">subESM</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subESM.html#~convRT">convRT</a></li><li data-type='method' style='display: none;'><a href="module-subESM.html#~convRT">convRT</a></li><li data-type='method' style='display: none;'><a href="module-subESM.html#~renewCanvasESM">renewCanvasESM</a></li><li data-type='method' style='display: none;'><a href="module-subESM.html#~renewCanvasESM">renewCanvasESM</a></li></ul></li><li></li><li><a href="module-subHAL.html">subHAL</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subHAL.html#~ranking">ranking</a></li><li data-type='method' style='display: none;'><a href="module-subHAL.html#~ranking">ranking</a></li><li data-type='method' style='display: none;'><a href="module-subHAL.html#~renewMajorResults">renewMajorResults</a></li><li data-type='method' style='display: none;'><a href="module-subHAL.html#~renewMajorResults">renewMajorResults</a></li><li data-type='method' style='display: none;'><a href="module-subHAL.html#~renewMinorResults">renewMinorResults</a></li><li data-type='method' style='display: none;'><a href="module-subHAL.html#~renewMinorResults">renewMinorResults</a></li></ul></li><li></li><li><a href="module-subHue.html">subHue</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subHue.html#~HueConfigSaved">HueConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~HueConfigSaved">HueConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~HuePowButton">HuePowButton</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~HuePowButton">HuePowButton</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~HueRename">HueRename</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~HueRename">HueRename</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~btnHueConfigSet_Click">btnHueConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~btnHueConfigSet_Click">btnHueConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~btnHueUseCancel_Click">btnHueUseCancel_Click</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~btnHueUseCancel_Click">btnHueUseCancel_Click</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~huerenamedlg%25E3%2582%2592%25E9%2596%258B%25E3%2581%258F">hue rename dlgを開く</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~huerenamedlg%25E3%2582%2592%25E9%2596%258B%25E3%2581%258F">hue rename dlgを開く</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~hueLinked">hueLinked</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~hueLinked">hueLinked</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~oncancel">oncancel</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~oncancel">oncancel</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~renewHueConfigView">renewHueConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subHue.html#~renewHueConfigView">renewHueConfigView</a></li></ul></li><li></li><li><a href="module-subIkea.html">subIkea</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subIkea.html#~IkeaConfigSaved">IkeaConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~IkeaConfigSaved">IkeaConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~IkeaPowButton">IkeaPowButton</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~IkeaPowButton">IkeaPowButton</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~btnIkeaConfigSet_Click">btnIkeaConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~btnIkeaConfigSet_Click">btnIkeaConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~ikeaLinked">ikeaLinked</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~ikeaLinked">ikeaLinked</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~renewFacilitiesIkea">renewFacilitiesIkea</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~renewFacilitiesIkea">renewFacilitiesIkea</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~renewIkeaConfigView">renewIkeaConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~renewIkeaConfigView">renewIkeaConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~renewIkeaLog">renewIkeaLog</a></li><li data-type='method' style='display: none;'><a href="module-subIkea.html#~renewIkeaLog">renewIkeaLog</a></li></ul></li><li></li><li><a href="module-subJma.html">subJma</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subJma.html#~JmaConfigSaved">JmaConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~JmaConfigSaved">JmaConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~btnJmaConfigSet_Click">btnJmaConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~btnJmaConfigSet_Click">btnJmaConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~inJmaArea_Change">inJmaArea_Change</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~inJmaArea_Change">inJmaArea_Change</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~makeJmaArea">makeJmaArea</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~makeJmaArea">makeJmaArea</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJma">renewJma</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJma">renewJma</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJmaAbst">renewJmaAbst</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJmaAbst">renewJmaAbst</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJmaConfigView">renewJmaConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJmaConfigView">renewJmaConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJmaDetail">renewJmaDetail</a></li><li data-type='method' style='display: none;'><a href="module-subJma.html#~renewJmaDetail">renewJmaDetail</a></li></ul></li><li></li><li><a href="module-subNetatmo.html">subNetatmo</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~NetatmoConfigSaved">NetatmoConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~NetatmoConfigSaved">NetatmoConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~btnNetatmoConfigSet_Click">btnNetatmoConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~btnNetatmoConfigSet_Click">btnNetatmoConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~netatmoDocSectionClicked">netatmoDocSectionClicked</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~netatmoDocSectionClicked">netatmoDocSectionClicked</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~newLegendClickHandler">newLegendClickHandler</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~newLegendClickHandler">newLegendClickHandler</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewCanvasNetatmo">renewCanvasNetatmo</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewCanvasNetatmo">renewCanvasNetatmo</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewNetatmo">renewNetatmo</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewNetatmo">renewNetatmo</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewNetatmoConfigView">renewNetatmoConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewNetatmoConfigView">renewNetatmoConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewRoomEnvNetatmo">renewRoomEnvNetatmo</a></li><li data-type='method' style='display: none;'><a href="module-subNetatmo.html#~renewRoomEnvNetatmo">renewRoomEnvNetatmo</a></li></ul></li><li></li><li><a href="module-subOmron.html">subOmron</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subOmron.html#~OmronConfigSaved">OmronConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~OmronConfigSaved">OmronConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~btnOmronConfigSet_Click">btnOmronConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~btnOmronConfigSet_Click">btnOmronConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~disconnectedOmron">disconnectedOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~disconnectedOmron">disconnectedOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~newLegendClickHandler">newLegendClickHandler</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~newLegendClickHandler">newLegendClickHandler</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~omronDocSectionClicked">omronDocSectionClicked</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~omronDocSectionClicked">omronDocSectionClicked</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewCanvasOmron">renewCanvasOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewCanvasOmron">renewCanvasOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewOmron">renewOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewOmron">renewOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewOmronConfigView">renewOmronConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewOmronConfigView">renewOmronConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewRoomEnvOmron">renewRoomEnvOmron</a></li><li data-type='method' style='display: none;'><a href="module-subOmron.html#~renewRoomEnvOmron">renewRoomEnvOmron</a></li></ul></li><li></li><li><a href="module-subOwm.html">subOwm</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subOwm.html#~OwmConfigSaved">OwmConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~OwmConfigSaved">OwmConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~btnOwmConfigSet_Click">btnOwmConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~btnOwmConfigSet_Click">btnOwmConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~renewOwm">renewOwm</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~renewOwm">renewOwm</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~renewOwmConfigView">renewOwmConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subOwm.html#~renewOwmConfigView">renewOwmConfigView</a></li></ul></li><li></li><li><a href="module-subQuestionnaire.html">subQuestionnaire</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subQuestionnaire.html#~getQuestionnaire">getQuestionnaire</a></li><li data-type='method' style='display: none;'><a href="module-subQuestionnaire.html#~getQuestionnaire">getQuestionnaire</a></li></ul></li><li></li><li><a href="module-subSwitchBot.html">subSwitchBot</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~SwitchBotConfigSaved">SwitchBotConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~SwitchBotConfigSaved">SwitchBotConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~SwitchBotPlug">SwitchBotPlug</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~SwitchBotPlug">SwitchBotPlug</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~btnSwitchBotConfigSet_Click">btnSwitchBotConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~btnSwitchBotConfigSet_Click">btnSwitchBotConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~newLegendClickHandler">newLegendClickHandler</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~newLegendClickHandler">newLegendClickHandler</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewCanvasSwitchBot">renewCanvasSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewCanvasSwitchBot">renewCanvasSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewFacilitiesSwitchBot">renewFacilitiesSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewFacilitiesSwitchBot">renewFacilitiesSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewRoomEnvSwitchBot">renewRoomEnvSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewRoomEnvSwitchBot">renewRoomEnvSwitchBot</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewSwitchBotConfigView">renewSwitchBotConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subSwitchBot.html#~renewSwitchBotConfigView">renewSwitchBotConfigView</a></li></ul></li><li></li><li><a href="module-subSystem.html">subSystem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subSystem.html#~SystemConfigSaved">SystemConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~SystemConfigSaved">SystemConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~URLopen">URLopen</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~URLopen">URLopen</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~btnNetworkConfigSet_Click">btnNetworkConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~btnNetworkConfigSet_Click">btnNetworkConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~btnSystemConfigSet_Click">btnSystemConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~btnSystemConfigSet_Click">btnSystemConfigSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~renewSystemConfigView">renewSystemConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subSystem.html#~renewSystemConfigView">renewSystemConfigView</a></li></ul></li><li></li><li><a href="module-subToast.html">subToast</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subToast.html#~addToast">addToast</a></li><li data-type='method' style='display: none;'><a href="module-subToast.html#~addToast">addToast</a></li><li data-type='method' style='display: none;'><a href="module-subToast.html#~redrawToast">redrawToast</a></li><li data-type='method' style='display: none;'><a href="module-subToast.html#~redrawToast">redrawToast</a></li></ul></li><li></li><li><a href="module-subUser.html">subUser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-subUser.html#~UserConfigSaved">UserConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subUser.html#~UserConfigSaved">UserConfigSaved</a></li><li data-type='method' style='display: none;'><a href="module-subUser.html#~btnUserProfileSet_Click">btnUserProfileSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subUser.html#~btnUserProfileSet_Click">btnUserProfileSet_Click</a></li><li data-type='method' style='display: none;'><a href="module-subUser.html#~renewUserConfigView">renewUserConfigView</a></li><li data-type='method' style='display: none;'><a href="module-subUser.html#~renewUserConfigView">renewUserConfigView</a></li></ul></li><li></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">mainSwitchBot.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//////////////////////////////////////////////////////////////////////
/** 
 * @file mainSwitchBot.js
 * @author SUGIMURA Hiroshi
 * @copyright © 2020.10.30 Sugimura Laboratory, KAIT
 * @license MIT
 */

//////////////////////////////////////////////////////////////////////
/**
 * @module mainSwitchBot
 */
'use strict'

//////////////////////////////////////////////////////////////////////
// 基本ライブラリ
const Store = require('electron-store');
const SBC   = require('switchbot-client');
const cron  = require('node-cron');
require('date-utils'); // for log
const { Sequelize, Op, sqlite3, switchBotRawModel, switchBotDataModel } = require('./models/localDBModels');   // DBデータと連携
const { objectSort, getNow, getToday, isObjEmpty, mergeDeeply} = require('./mainSubmodule');

const store = new Store();

/** mainSwitchBotのconfig */
let config =  {
	enabled: false,
	token: '',
	debug: false
};

/** mainSwitchBotのpersist */
let persist = {};

/** mainSwitchBotからIPCMessageを呼ぶためのcallback */
let sendIPCMessage = null;

//////////////////////////////////////////////////////////////////////
/** mainSwitchBot
 *  @desc SwitchBotとの通信を管理
 */
let mainSwitchBot = {
	/** @member client
	 *  @desc SwitchBotとの接続を保持
	 *  @default null
	 */
	client: null,
	/** @member observationJob
	 *  @desc 定期的にSwitchBotの状態を取得するタイマー
	 *  @default null
	 */
	observationJob: null,
	/** @member callback
	 *  @desc SwitchBotの状態を取得したら呼ばれる関数を保持
	 *  @default null
	 */
	callback: null,
	/** @member isRun
	 *  @desc 初期化して起動済みのフラグ
	 *  @default null
	 */
	isRun: false,

	//////////////////////////////////////////////////////////////////////
	// interfaces
	/**
	 * @async
	 * @function start
	 * @param {sendIPCMessage} [_sendIPCMessage]
	 * @return {void}
	*/
	start: function ( _sendIPCMessage ) {
		sendIPCMessage = _sendIPCMessage;

		if( mainSwitchBot.isRun ) {
			if( !isObjEmpty(persist) ) {
				sendIPCMessage( "renewSwitchBotConfigView", config );
				sendIPCMessage( "fclSwitchBot", persist );
				mainSwitchBot.sendTodayRoomEnv();		// 現在のデータを送っておく
			}
			return;
		}

		config.enabled    = store.get('config.SwitchBot.enabled', false);
		config.debug      = store.get('config.SwitchBot.debug',   false);
		config.token      = store.get('config.SwitchBot.token',   '');
		persist = store.get('persist.SwitchBot', {});

		sendIPCMessage( "renewSwitchBotConfigView", config );

		if( !config.enabled ) {
			config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot is disabled.'):0;
			mainSwitchBot.isRun = false;
			return;
		}
		mainSwitchBot.isRun = true;

		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.start()'):0;

		if( config.token == '' ) {
			config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.start() token is empty.'):0;
			mainSwitchBot.isRun = false;
			return;
		}

		try{
			mainSwitchBot.startCore( (facilities) => {
				persist = facilities;
				sendIPCMessage( "fclSwitchBot", persist );
				switchBotRawModel.create({ detail: JSON.stringify(persist) });  // store raw data
				mainSwitchBot.storeData( facilities );  // store meaningfull data
				mainSwitchBot.sendTodayRoomEnv();		// 現在のデータを送っておく
			});
		} catch(error) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.start() error:\x1b[32m', error, '\x1b[0m');
		}
	},
	
	/**
	 * @async
	 * @function stop
	 * @param {void} [void]
	 * @return {void}
	*/
	stop: async function () {
		mainSwitchBot.isRun = false;
		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.stop()'):0;

		await mainSwitchBot.stopObservation();
		await store.set('config.SwitchBot', config );
		await store.set('persist.SwitchBot', persist );
	},

	/**
	 * @async
	 * @function stopWithoutSave
	 * @param {void} [void]
	 * @return {void}
	*/
	stopWithoutSave: async function () {
		mainSwitchBot.isRun = false;
		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.stopWithoutSave()'):0;

		await mainSwitchBot.stopObservation();
	},


	/**
	 * @async
	 * @function setConfig
	 * @param {_config} [_config]
	 * @return {void}
	*/
	setConfig: async function (_config) {
		if( _config ) {
			config = mergeDeeply( config, _config );
		}

		await store.set('config.SwitchBot', config);

		sendIPCMessage( "configSaved", 'SwitchBot' );  // 保存したので画面に通知
		sendIPCMessage( "renewSwitchBotConfigView", config );  // 保存したので画面に通知
	},

	/**
	 * @async
	 * @function getConfig
	 * @param {void}
	 * @return {config}
	*/
	getConfig: function () {
		return config;
	},


	/**
	 * @async
	 * @function getPersist
	 * @param {void}
	 * @return {persist}
	*/
	getPersist: function() {
		return persist;
	},

	// デバイスタイプごとに制御
	/**
	 * @async
	 * @function control
	 * @param {id} [id]
	 * @param {command} [command]
	 * @return {void}
	*/
	control: async function( id, command ) {
		// mainSwitchBot.client
		console.log(new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.control() id:', id, 'command:', command);

		let r = await mainSwitchBot.client.sendControlCommand(id, command);
		console.log( 'mainSwitchBot.client.sendControlCommand ret:', r );
	},


	//////////////////////////////////////////////////////////////////////
	// inner functions
	/**
	 * @async
	 * @function renewFacilities
	 * @param {_client} [_client]
	 * @return {object} ret
	*/
	renewFacilities: async function ( _client ) {
		let ret = {};
		try{
			let devlist = await _client.getDeviceList();
			// mainSwitchBot.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.renewFacilities() devlist:\x1b[32m', devlist, '\x1b[0m' ):0;
			ret.deviceList = devlist.deviceList;
			ret.infraredRemoteList = devlist.infraredRemoteList;
			for( let d of ret.deviceList) {
				ret[d.deviceId] = await _client.getDeviceStatus( d.deviceId );
			}
		}catch(error) {
			switch(error) {
				case 'Error: Http 401 Error. User permission is denied due to invalid token.':
				console.log( JSON.stringify(_client) );
				break;
			}

			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.renewFacilities() error:\x1b[32m', error, '\x1b[0m');
			throw error;
		}

		return objectSort( ret );
	},


	//////////////////////////////////////////////////////////////////////
	// 定時処理のインタフェース
	// 監視開始
	/**
	 * @async
	 * @function startCore
	 * @callback {_callback} [_callback]
	 * @return {void}
	*/
	startCore: async function( _callback ) {
		if( !config.token || config.token == '' ) {
			throw new Error('mainSwitchBot.startCore() config.token is empty.');
		}

		mainSwitchBot.callback = _callback;
		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.startCore() config:\x1b[32m', config, '\x1b[0m' ):0;

		try{
			mainSwitchBot.client = new SBC.RestClient( config.token );

			mainSwitchBot.facilities = await mainSwitchBot.renewFacilities( mainSwitchBot.client );  // 一回実行
			mainSwitchBot.callback( mainSwitchBot.facilities );  // mainに通知

			// 監視はcronで実施、処理が相当重いので3分毎、DBへのクエリ方法をもっと高速になるように考えたほうが良い
			// 1分に1回実施
			mainSwitchBot.observationJob = cron.schedule('*/1 * * * *', async () => {
				config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.cron.schedule()'):0;

				mainSwitchBot.facilities = await mainSwitchBot.renewFacilities( mainSwitchBot.client );  // 現在のデータ取得
				mainSwitchBot.callback( mainSwitchBot.facilities );  // mainに通知
			});

			mainSwitchBot.observationJob.start();
		}catch( error ) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.startCore() error:\x1b[32m', error, '\x1b[0m');
		}
	},

	// 監視をやめる
	/**
	 * @async
	 * @function stopObservation
	 * @param {void} [void]
	 * @return {void}
	*/
	stopObservation: function() {
		config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.stopObserve().' ):0;

		if( mainSwitchBot.observationJob ) {
			mainSwitchBot.observationJob.stop();
			mainSwitchBot.observationJob = null;
			config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.stopObserve() is stopped.' ):0;
		}else{
			config.debug?console.log( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.stopObserve() has already stopped.' ):0;
		}

		// mainSwitchBot.client.close();  // axiosのソケットcloseの方法不明
	},


	// デバイスタイプごとにステータスの読見方を変えてDBにためる
	/**
	 * @async
	 * @function storeData
	 * @param {facilities} [facilities]
	 * @return {void}
	*/
	storeData: async function( facilities ) {
		for( let d of facilities.deviceList ) {
			let det = facilities[d.deviceId];
			// console.log( 'SwitchBot:dev:', d, ' detail:', det );

			switch( d.deviceType ) {
				case 'Plug':
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'power',
					value:      det.power
				});
				break;

				case 'Meter':
				case 'MeterPlus':
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'temperature',
					value:      det.temperature
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'humidity',
					value:      det.humidity
				});
				break;

				case 'Curtain':  // カーテン
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'slidePosition',
					value:      det.slidePosition
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'openDirection',
					value:      d.openDirection
				});
				break;

				case 'Humidifier':  // 加湿器
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'power',
					value:      det.power
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'humidity',
					value:      det.humidity
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'temperature',
					value:      det.temperature
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'lackWater',
					value:      det.lackWater
				});
				break;

				case 'Motion Sensor':  // 人感センサ＝動きセンサ
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'moveDetected',
					value:      det.moveDetected
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'brightness',
					value:      det.brightness
				});
				break;

				case 'Contact Sensor':  // 開閉センサ＝接触センサ
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'moveDetected',
					value:      det.moveDetected
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'brightness',
					value:      det.brightness
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'openState',
					value:      det.openState
				});
				break;

				case 'Color Bulb':  // ライト
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'power',
					value:      det.power
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'brightness',
					value:      det.brightness
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'color',
					value:      det.color
				});
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'colorTemperature',
					value:      det.colorTemperature
				});
				break;

				case 'Bot':  // ボット
				switchBotDataModel.create({
					deviceId:   d.deviceId,
					deviceType: d.deviceType,
					deviceName: d.deviceName,
					property:   'power',
					value:      det.power
				});
				break;

				// 以下はDB格納無し
				case 'Hub Mini': break;
				case 'Indoor Cam': break;
				case 'Remote': break;

				default:
				// console.log( 'unknown device in SwitchBot:dev:', d, ' detail:', det );
				// 屋外カメラはなぜかdeviceType持ってない
				break;
			}
		}
	},

	//////////////////////////////////////////////////////////////////////
	// 定時処理
	/*
	getCases
	input
		date: Date="2023-01-06"

	output
		when createdAt >= "2023-01-05 23:57" and createdAt &lt; "2023-01-06 00:00" then "00:00"
		when createdAt >= "2023-01-06 00:00" and createdAt &lt; "2023-01-06 00:03" then "00:03"
		when createdAt >= "2023-01-06 00:03" and createdAt &lt; "2023-01-06 00:06" then "00:06"
		...
		when createdAt >= "2023-01-06 23:54" and createdAt &lt; "2023-01-06 23:57" then "23:57"
		else "24:00"
	*/
	/**
	 * @async
	 * @function getCases
	 * @param {date} [date]
	 * @return {ret}
	*/
	getCases: function ( date ) {
		let T1 = new Date(date);
		let T2 = new Date(date);
		let T3 = new Date(date);
		let T4 = new Date(date);

		// UTCだがStringにて表現しているので、なんか複雑
		T1.setHours( T1.getHours() - T1.getHours() -10, 57, 0, 0 ); // 前日の14時57分xx秒   14:57:00 .. 15:00:00 --> 00:00
		T2.setHours( T1.getHours() - T1.getHours() -10, 58, 0, 0 ); // T1 + 1min
		T3.setHours( T1.getHours() - T1.getHours() -10, 59, 0, 0 ); // T1 + 2min
		T4.setHours( T1.getHours() - T1.getHours()   ,  0, 0, 0 ); // 集約先

		let ret = "";
		for( let t=0; t&lt;480; t+=1 ) {  // 24h * 20 times (= 60min / 3min)
			// console.log( T1.toISOString(), ':', T1.toFormat('YYYY-MM-DD HH24:MI'), ', ', T4.toFormat('HH24:MI') );

			ret += `WHEN "createdAt" LIKE "${T1.toFormat('YYYY-MM-DD HH24:MI')}%" OR "createdAt" LIKE "${T2.toFormat('YYYY-MM-DD HH24:MI')}%" OR "createdAt" LIKE "${T3.toFormat('YYYY-MM-DD HH24:MI')}%" THEN "${T4.toFormat('HH24:MI')}" \n`;

			T1.setMinutes( T1.getMinutes() +3 ); // + 3 min
			T2.setMinutes( T2.getMinutes() +3 ); // + 3 min
			T3.setMinutes( T3.getMinutes() +3 ); // + 3 min
			T4.setMinutes( T4.getMinutes() +3 ); // + 3 min
		}
		return ret + 'ELSE "24:00"';
	},

	// meterListを取得
	/**
	 * @async
	 * @function getMeterList
	 * @param {theDayBegin} [theDayBegin]
	 * @param {theDayEnd} [theDayEnd]
	 * @return {rows}
	*/
	getMeterList: async function( theDayBegin, theDayEnd ) {
		let meterList = [];
		try{
			// 1日分で記録があるデバイスリスト（温湿度計）
			let rows = [];
			rows = await switchBotDataModel.findAll( {
				attributes: ['deviceName' ],
				group: ['deviceName'],
				where: {
					deviceType: { [Op.or]: ['Meter','MeterPlus'] },
					createdAt: { [Op.between] : [theDayBegin.toISOString(), theDayEnd.toISOString()] }
				}
			} );
			for( const row of rows ) {
				meterList.push( row.dataValues.deviceName );
			}
			return meterList;
		} catch( error ) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.getMeterList()', error);
		}
	},


	// 3分毎のtemperature
	/**
	 * @async
	 * @function getTempratureRows
	 * @param {theDayBegin} [theDayBegin]
	 * @param {theDayEnd} [theDayEnd]
	 * @param {meter} [meter]
	 * @param {subQuery} [subQuery]
	 * @return {rows}
	*/
	getTempratureRows: async function( theDayBegin, theDayEnd, meter, subQuery ) {
		try{
			// 3分毎データ tempreture
			let rows = await switchBotDataModel.findAll( {
				attributes: [
					[Sequelize.fn('AVG', Sequelize.col('value')), 'avgTemperature'],
					'createdAt',
					[Sequelize.literal(subQuery), 'timeunit']
					],
				where: {
					deviceType: { [Op.or]: ['Meter','MeterPlus'] },
					deviceName: meter,
					property:  'temperature',
					createdAt: { [Op.between] : [theDayBegin.toISOString(), theDayEnd.toISOString()] }
				},
				group: ['timeunit']
			} );

			return rows;
		} catch( error ) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.getTempratureRows()', error);
		}
	},

	// 3分毎のhumidity
	/**
	 * @async
	 * @function getHumidityRows
	 * @param {sendIPCMessage} [_sendIPCMessage]
	 * @return {rows}
	*/
	getHumidityRows: async function( theDayBegin, theDayEnd, meter, subQuery ) {
		let ret = [];
		try{
			// 3分毎データ humidity
			let rows = await switchBotDataModel.findAll( {
				attributes: [
					[Sequelize.fn('AVG', Sequelize.col('value')), 'avgHumidity'],
					'createdAt',
					[Sequelize.literal(subQuery), 'timeunit']
					],
				where: {
					deviceType: { [Op.or]: ['Meter','MeterPlus'] },
					deviceName: meter,
					property:  'humidity',
					createdAt: { [Op.between] : [theDayBegin.toISOString(), theDayEnd.toISOString()] }
				},
				group: ['timeunit']
			} );

			return rows;
		} catch( error ) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.getHumidityRows()', error);
		}
	},


	// DBからテーブル取得
	/**
	 * @async
	 * @function getTodayRoomEnvSwitchBot
	 * @param {void}
	 * @return {object}
	*/
	getTodayRoomEnvSwitchBot: async function() {
		// 画面に今日のデータを送信するためのデータ作る
		let ret = {	srcType: 'switchBot', meterList:[] }; // 戻り値  // { meterList:[], meter1:[], meter2[], .... }

		try {
			let now = new Date();  // 現在
			let begin = new Date(now);  // 現在時刻UTCで取得
			begin.setHours( begin.getHours() - begin.getHours() - 1, 57, 0, 0 ); // 前日の23時57分０秒にする
			let end = new Date(begin);  // 現在時刻UTCで取得
			end.setHours( begin.getHours() + 25, 0, 0, 0 ); // 次の日の00:00:00にする

			// 温湿度計のリストを取得
			ret.meterList = await mainSwitchBot.getMeterList( begin, end );

			//------------------------------------------------------------
			// 温湿度計毎にデータ作る
			let cases = mainSwitchBot.getCases( now );
			let subQuery = `CASE ${cases} END`;

			for( const meter of ret.meterList ) {
				let rowsT = await mainSwitchBot.getTempratureRows( begin, end, meter, subQuery );			// 3分毎データ tempreture
				let rowsH = await mainSwitchBot.getHumidityRows( begin, end, meter, subQuery );			// 3分毎データ humidity

				// console.log( rowsT );
				// console.log( rowsH );

				let T1 = new Date();
				T1.setHours( 0, 0, 0);
				let array = [];
				for( let t=0; t&lt;480; t+=1 ) {
					let pushRow = {
						id: t,
						time: T1.toISOString()
					}

					// temperature
					if( rowsT ) {
						let row = rowsT.find( (row) => row.dataValues.timeunit == T1.toFormat('HH24:MI') );

						if( row ) {
							pushRow.temperature = row.dataValues.avgTemperature;
						}else{
							pushRow.temperature = null;
						}
					}

					// humidity
					if( rowsH ) {
						let row = rowsH.find( (row) => row.dataValues.timeunit == T1.toFormat('HH24:MI') );

						if( row ) {
							pushRow.humidity = row.dataValues.avgHumidity;
						}else{
							pushRow.humidity = null;
						}
					}

					array.push( pushRow );
					T1.setMinutes( T1.getMinutes() +3 ); // + 3 min
				}

				ret[meter] = array;
			}

			return ret;
		} catch( error ) {
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.getTodayRoomEnvSwitchBot()', error);
		}
	},

	/**
	 * @async
	 * @function sendTodayRoomEnv
	 * @param {void}
	 * @return {void}
	*/
	sendTodayRoomEnv: async function( ) {
		let arg = { };

		if( config.enabled ) {
			arg = await mainSwitchBot.getTodayRoomEnvSwitchBot();
			sendIPCMessage( 'renewRoomEnvSwitchBot', JSON.stringify(arg) );
		}else{
			console.error( new Date().toFormat("YYYY-MM-DDTHH24:MI:SS"), '| mainSwitchBot.sendTodayRoomEnv() config.enabled:', config.enabled);
		}
	}

};


module.exports = mainSwitchBot;
//////////////////////////////////////////////////////////////////////
// EOF
//////////////////////////////////////////////////////////////////////
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.2</a> on Tue May 30 2023 17:02:24 GMT+0900 (日本標準時) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
